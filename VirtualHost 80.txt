<VirtualHost *:80>
  ServerName app.stockloyal.com
  DocumentRoot "/opt/bitnami/apache/htdocs"

  # Let Apache know we might be behind a proxy (Lightsail/LB/CDN)
  SetEnvIf X-Forwarded-Proto https HTTPS=on

  # --- API: serve PHP from /opt/bitnami/apache/htdocs/api via PHP-FPM ---
  Alias /api /opt/bitnami/apache/htdocs/api
  <Directory "/opt/bitnami/apache/htdocs/api">
    AllowOverride None
    Require all granted
    <FilesMatch "\.php$">
      SetHandler "proxy:unix:/opt/bitnami/php/var/run/www.sock|fcgi://localhost/"
    </FilesMatch>
  </Directory>

  # --- SPA fallback: any non-file/non-dir (that isn’t /api) → /index.html ---
  <Directory "/opt/bitnami/apache/htdocs">
    Options FollowSymLinks
    AllowOverride None
    Require all granted

    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.html [L]
  </Directory>

  ErrorLog  "/opt/bitnami/apache/logs/error_log"
  CustomLog "/opt/bitnami/apache/logs/access_log" combined
</VirtualHost>

