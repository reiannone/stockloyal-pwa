<?php
declare(strict_types=1);

header('Content-Type: text/plain; charset=utf-8');
require __DIR__ . '/_loadenv.php';

$h = $_ENV['DB_HOST'] ?? '127.0.0.1';
$p = (int)($_ENV['DB_PORT'] ?? 3306);
$d = $_ENV['DB_NAME'] ?? '';
$u = $_ENV['DB_USER'] ?? '';
$w = $_ENV['DB_PASS'] ?? '';
$ca = $_ENV['DB_SSL_CA'] ?? null;
$sslMode = strtolower($_ENV['DB_SSL_MODE'] ?? 'off');

echo "Trying mysql TLS=$sslMode host=$h port=$p db=$d user=$u\n";

$options = [
  PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
  PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
  PDO::ATTR_TIMEOUT => 8,
];

if ($sslMode !== 'off') {
  if (!$ca || !is_file($ca)) {
    echo "FAIL: CA file missing at $ca\n"; exit;
  }
  $options[PDO::MYSQL_ATTR_SSL_CA] = $ca;
  if (defined('PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT')) {
    $options[PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT] = true;
  }
}

try {
  $pdo = new PDO("mysql:host=$h;port=$p;dbname=$d;charset=utf8mb4", $u, $w, $options);
  echo "OK: connected.\n";
} catch (Throwable $e) {
  echo "FAIL: " . $e->getMessage() . "\n";
}
